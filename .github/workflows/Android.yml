name: Build Android APK

on:
  push:
  workflow_dispatch:

jobs:
  apk:
    runs-on: ubuntu-latest

    steps:
    - uses: actions/checkout@v4
      with:
        submodules: recursive

    - name: Setup Java
      uses: actions/setup-java@v4
      with:
        distribution: temurin
        java-version: 17

    - name: Setup Android SDK
      uses: android-actions/setup-android@v3

    - name: Install NDK
      run: sdkmanager "ndk;23.2.8568313"

    - name: Build native libs
      env:
        ANDROID_NDK_HOME: ${{ env.ANDROID_SDK_ROOT }}/ndk/23.2.8568313
      run: |
        cmake -S . -B build-android \
          -DCMAKE_TOOLCHAIN_FILE=$ANDROID_NDK_HOME/build/cmake/android.toolchain.cmake \
          -DANDROID=ON \
          -DANDROID_ABI=arm64-v8a \
          -DANDROID_PLATFORM=android-21
        cmake --build build-android

    - name: Copy .so to APK project
      run: |
        mkdir -p android-apk/app/src/main/jniLibs/arm64-v8a
        cp build-android/**/*.so android-apk/app/src/main/jniLibs/arm64-v8a/

    - name: Build APK
      working-directory: android-apk
      run: |
        chmod +x ./gradlew || true
        ./gradlew assembleRelease

    - name: Upload APK
      uses: actions/upload-artifact@v4
      with:
        name: rsdk-origins-apk
        path: android-apk/app/build/outputs/apk/release/*.apk
        
